// Evaluate the ratio of Bessel functions f(x) = x*K1(x)/K0(x)
const LN2_MINUS_EULER_GAMMA: f64 = 0.11593151565841244881;
const SPLINE_STEP: f64 = 0.2;
const SPLINE_NUMBER: usize = 25;
const ASYMPTOTIC_ORDER: usize = 5;

// This evaluates K1(x)/K0(x) for x >= 5 and n >= 4 with an error better than 1e-4
pub fn bessel_ratio_asymptotic(n: usize, a: f64, x: f64) -> f64 {
    let y = 8.0 * x;
    let n_f64 = n as f64;

    // Compute P sequence
    let mut p = (4.0 * a.powi(2) - (2.0 * n_f64 - 1.0).powi(2)) / (n_f64 * y);
    for k in (1..n).rev() {
        let k_f64 = k as f64;
        let numerator_p = 4.0 * a.powi(2) - (2.0 * k_f64 - 1.0).powi(2);
        let denominator_p = k_f64 * y;
        p = (numerator_p / denominator_p) * (1.0 + p);
    }

    // Compute Q sequence
    let a_minus_1 = a - 1.0;
    let mut q = (4.0 * a_minus_1.powi(2) - (2.0 * n_f64 - 1.0).powi(2)) / (n_f64 * y);
    for k in (1..n).rev() {
        let k_f64 = k as f64;
        let numerator_q = 4.0 * a_minus_1.powi(2) - (2.0 * k_f64 - 1.0).powi(2);
        let denominator_q = k_f64 * y;
        q = (numerator_q / denominator_q) * (1.0 + q);
    }

    (1.0 + p) / (1.0 + q)
}

// This evaluates a spline approximation for a function g(x)=1-(LN2_MINUS_EULER_GAMMA-ln(x))*f(x)
pub fn evaluate_spline_from_zero(
    x: f64,
    h: f64,
    n: usize,
    alpha: &[f64],
    beta: &[f64],
    gamma: &[f64],
    delta: &[f64],
) -> f64 {
    let x_rel = x / h;
    let mut j = x_rel.floor() as usize;
    if j > n-1 {j = n-1};
    let x_j = j as f64;
    let t = x_rel - x_j;
    (alpha[j] / 6.0) * t.powi(3) + (beta[j] / 2.0) * t.powi(2) + gamma[j] * t + delta[j]
}

pub fn bessel_ratio(
    x: f64,
) -> f64 {
    if x < 5.0 {
        let g = evaluate_spline_from_zero(x, SPLINE_STEP, SPLINE_NUMBER, &COEFF_ALPHA, &COEFF_BETA, &COEFF_GAMMA, &COEFF_DELTA);
        return (1.0-g)/(LN2_MINUS_EULER_GAMMA - x.ln())
    } else {
        return bessel_ratio_asymptotic(ASYMPTOTIC_ORDER, 1.0, x)*x
    }
}

const COEFF_ALPHA: [f64; 25] = [
    -0.0931423681620698,
    -0.0087288759998848,
    -0.0121526767400692,
    -0.0054702769326671,
    -0.0044904618587249,
    -0.003163511343056,
    -0.0025087338175732,
    -0.0019966639631875,
    -0.0016424560193524,
    -0.0013727526494532,
    -0.0011664063977909,
    -0.001003654348448,
    -0.0008732121211744,
    -0.0007668876324683,
    -0.0006790521760808,
    -0.0006056124644905,
    -0.0005435641133005,
    -0.0004906505134871,
    -0.0004451514168921,
    -0.000405735246063,
    -0.0003713586908394,
    -0.0003411917222321,
    -0.0003145777125402,
    -0.0002909519287959,
    -0.0002699770219526,
];

const COEFF_BETA: [f64; 25] = [
    0.150452057238239,
    0.0573096890761688,
    0.048580813076284,
    0.0364281363362148,
    0.0309578594035478,
    0.0264673975448229,
    0.023303886201767,
    0.0207951523841937,
    0.0187984884210062,
    0.0171560324016539,
    0.0157832797522006,
    0.0146168733544097,
    0.0136132190059616,
    0.0127400068847872,
    0.0119731192523189,
    0.0112940670762381,
    0.0106884546117475,
    0.010144890498447,
    0.00965423998496,
    0.0092090885680679,
    0.0088033533220049,
    0.0084319946311655,
    0.0080908029089334,
    0.0077762251963933,
    0.0074852732675974,
];

const COEFF_GAMMA: [f64; 25] = [
    5.05E-14,
    0.103880873157181,
    0.156826124233423,
    0.199330598939486,
    0.233023596809445,
    0.261736225283233,
    0.286621867156778,
    0.308671386449137,
    0.328468206852248,
    0.346445467262859,
    0.362915123340537,
    0.378115199893227,
    0.392230246074254,
    0.405406859019259,
    0.417763422088548,
    0.429397015252705,
    0.440388276097205,
    0.450804948652332,
    0.460704513894317,
    0.470136178170905,
    0.479142399116069,
    0.487760073092708,
    0.496021471862802,
    0.503954985915488,
    0.5115857351475,
];

const COEFF_DELTA: [f64; 25] = [
    0.0,
    0.0597023005921581,
    0.190783205620776,
    0.369874290268996,
    0.586507244554479,
    0.83426136075591,
    1.10870403292105,
    1.40655972087578,
    1.72529590618981,
    2.06288961458267,
    2.41768430593812,
    2.78829666808845,
    3.17355302893415,
    3.57244434915785,
    3.98409339701409,
    4.40773020336612,
    4.8426733167462,
    5.28831522613039,
    5.74411084494637,
    6.20956828693035,
    6.68424138684428,
    7.16772356950621,
    7.65964277462746,
    8.15965721832597,
    8.66745182485152,    
];